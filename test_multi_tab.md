# 多标签页终端测试指南

## 🔧 修复状态
✅ **API路径问题已修复**: 修正了重复的 `/api/v1/api/v1/` 路径
✅ **会话复用功能已实现**: 多个请求会复用同一个 ttyd 会话
✅ **认证保护已添加**: 代理路径现在需要有效的认证token
✅ **URL构建已修复**: 修正了 undefined URL 问题

## 测试步骤

### 1. 基础功能测试
1. 访问 http://localhost:8080
2. 使用 admin/admin 登录
3. 进入服务器管理页面，连接到服务器ID=3 (测试2)
4. **检查浏览器控制台**: 应该看到调试信息显示正确的session数据
5. 确认终端正常工作

### 2. 多标签页测试
1. 在当前终端正常工作的情况下
2. 在浏览器中新开一个标签页 (Ctrl+T / Cmd+T)
3. 访问 http://localhost:8080
4. 导航到同一个服务器并点击连接
5. **预期结果**: 新标签页应该能够正常显示终端界面并接收输入
6. **检查控制台**: 应该看到 "复用现有ttyd会话" 的日志信息

### 3. 会话共享测试
1. 在第一个标签页的终端中输入一些命令 (如 `ls`, `pwd`)
2. 切换到第二个标签页
3. **预期结果**: 两个标签页应该显示相同的终端会话内容
4. 在任一标签页输入命令，另一个标签页应该同步显示

### 4. 认证测试
1. 清除浏览器 localStorage (开发者工具 -> Application -> Local Storage -> Clear All)
2. 刷新页面，应该跳转到登录页面
3. 重新登录后测试多标签页功能

### 5. 调试信息检查
打开浏览器开发者工具 (F12)，在控制台中应该看到：
- `Terminal session data: {session_id: "...", port: 7681, url: "..."}`
- `Final URL with token: http://localhost:8080/proxy-terminal?session_id=...&token=...`

## 修改内容总结

### 后端修改
1. **会话复用机制**: 添加了 `FindActiveSession` 方法，允许多个请求复用同一个 ttyd 会话
2. **代理路径认证**: 为 `/proxy-terminal` 路由添加了认证中间件
3. **权限检查增强**: 在代理方法中添加了用户权限验证

### 前端修改
1. **认证状态检查**: 在 TTYDTerminal 组件中添加了认证状态验证
2. **Token 传递**: 在 iframe URL 中添加 token 参数
3. **错误处理改进**: 增强了错误处理和用户反馈

## 预期解决的问题
1. ✅ 新标签页终端无响应 -> 现在应该能正常工作
2. ✅ 认证链断裂 -> 添加了完整的认证保护
3. ✅ 会话隔离 -> 现在支持会话共享
4. ✅ 状态同步问题 -> 改进了认证状态管理
